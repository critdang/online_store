<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashbroad</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0-beta1/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-0evHe/X+R7YkIZDRvuzKMRqM+OrBnVFBL6DOitfPri4tjfHxaWutUpFmBp4vmVor" crossorigin="anonymous">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>

    <link href="/css/style.css" rel="stylesheet" type="text/css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css"
        integrity="sha512-KfkfwYDsLkIlwQp6LFnl8zNdLGxu9YAA1QvwINks4PhcElQSvqcyVLLD9aMhXd13uQjoXtEKNosOWaZqXgel0g=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />
</head>

<body>
    <div class="row background">
        <%- include('../components/adminNav.ejs')%>

            <div class="col-10">
                <div class="row background">
                    <div class="col-3">
                        <div class="total_item">
                            <div class="total_item--detail">

                                <div class="total_item--p">
                                    <p>Total Order</p>
                                    <p class="total_item--des">
                                        <%=orders.length%>
                                    </p>
                                    <a href="http://localhost:4007/admin/orders">View more</a>
                                </div>
                            </div>
                            <div class="total_item--detail">
                                <div class="total_item--img">
                                    <i style="color:purple" class="menu-item__img fa-solid fa-file-invoice"></i>
                                </div>
                            </div>
                        </div>

                    </div>
                    <div class="col-3">
                        <div class="total_item">
                            <div class="total_item--detail">
                                <div class="total_item--p">
                                    <p>Total User</p>
                                    <p class="total_item--des">
                                        <%=users.length %>
                                    </p>
                                    <a href="http://localhost:4007/admin/users">View more</a>

                                </div>
                            </div>
                            <div class="total_item--detail">
                                <div class="total_item--img">
                                    <i style="color:green" class="fa-solid fa-image-portrait"></i>

                                </div>
                            </div>
                        </div>

                    </div>
                    <div class="col-3">
                        <div class="total_item">
                            <div class="total_item--detail">
                                <div class="total_item--p">
                                    <p> Categories</p>
                                    <p class="total_item--des">
                                        <%=categories.length%>
                                    </p>
                                    <a href="http://localhost:4007/admin/categories">View more</a>
                                </div>
                            </div>
                            <div class="total_item--detail">
                                <div class="total_item--img">
                                    <i style="color:pink" class="menu-item__img fa-solid fa-circle-chevron-down"></i>
                                </div>
                            </div>
                        </div>

                    </div>
                    <div class="col-3">
                        <div class="total_item">
                            <div class="total_item--detail">
                                <div class="total_item--p">

                                    <p>Total Product</p>
                                    <p class="total_item--des">
                                        <%=products.length%>
                                    </p>
                                    <a href="http://localhost:4007/admin/products">View more</a>
                                </div>

                            </div>
                            <div class="total_item--detail">
                                <div class="total_item--img">
                                    <i style="color:red" class="menu-item__img fa-brands fa-product-hunt"></i>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="col-7">
                        <div class="order-item" style="margin-top: 20px" ;>
                            <div class="order-heading">
                                <h3>Order</h3>
                            </div>

                            <table style="width: 90%;">
                                <tr>
                                    <th>No.</th>
                                    <th>Status</th>
                                    <th>Payment Method</th>
                                    <th>Payment Date</th>
                                </tr>
                                <% for(var i=0; i<orders.length;i++) { %>
                                    <tr>
                                        <td>
                                            <%=i+1%>
                                        </td>
                                        <td class="order-item--des">
                                            <span>

                                                <%=orders[i].status%>
                                            </span>
                                        </td>
                                        <td>
                                            <%=orders[i].paymentMethod%>
                                        </td>
                                        <td>
                                            <%=orders[i].paymentDate%>
                                        </td>
                                        <td>
                                            <%- include('../components/modalOrder.ejs',{order:orders[i]})%>
                                        </td>
                                    </tr>
                                    <% } %>
                            </table>
                        </div>
                    </div>
                    <div class="col-5" style="margin-top:20px">
                        <div class="category-item">
                            <div class="category-heading"
                                style="display: flex; justify-content: space-between; align-items: center;">
                                <h3>Category</h3>
                                <%- include('../createForm/category.ejs')%>
                            </div>

                            <table style="width: 90%;">
                                <tr>
                                    <th>No.</th>
                                    <th>Name</th>
                                    <th>Thumbnail</th>
                                    <th>Description</th>
                                </tr>
                                <% for(let i=0; i<categories.length;i++) { %>
                                    <tr>
                                        <td>
                                            <%=i+1%>
                                        </td>
                                        <td class="category-item--des">
                                            <%=categories[i].name%>
                                        </td>
                                        <td><img style="width: 60px;" src="<%=categories[i].thumbnail%>" alt=""></td>
                                        <td>
                                            <%=categories[i].description%>
                                        </td>
                                        <td>
                                            <%- include('../components/modalCategory.ejs', {category:categories[i]})%>

                                        </td>
                                    </tr>
                                    <% } %>
                            </table>
                        </div>
                    </div>
                    <div class="col-12">
                        <div class="product-item" style="margin-top: 20px;">
                            <div class="product-heading"
                                style="display: flex; justify-content: space-between; align-items: center;">
                                <h3>Product</h3>
                                <%- include('../createForm/product.ejs', {category:categories[i]})%>

                            </div>
                            <div class="row">
                                <div class="detail-body">
                                    <table style="width: 100%;line-height: 50px;">
                                        <tr>
                                            <th>No.</th>
                                            <th>Name</th>
                                            <th>Amount</th>
                                            <th>Price</th>
                                            <th>Category</th>
                                            <th>Description</th>
                                            <th>Image</th>
                                        </tr>
                                        <% for(var i=0; i<products.length;i++) { %>
                                            <tr>
                                                <td>
                                                    <%=i+1%>
                                                </td>
                                                <td>
                                                    <%=products[i].name%>
                                                </td>
                                                <td>
                                                    <%=products[i].amount%>
                                                </td>
                                                <td>
                                                    <%=products[i].price%>
                                                </td>
                                                <td>
                                                    <%products[i].categoryProduct.forEach(function(category){%>
                                                        <%=category.category.name%>,
                                                            <%})%>
                                                </td>
                                                <td>
                                                    <%=products[i].description%>
                                                </td>
                                                <td>
                                                    <%products[i].productImage.forEach(function(img){%>
                                                        <img width="100px" src="<%=img.href%>" alt="">
                                                        <%})%>
                                                </td>
                                                <td>
                                                    <%- include('../components/modalProduct.ejs',
                                                        {product:products[i]})%>
                                                </td>
                                            </tr>
                                            <% } %>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-12" style="margin-top:20px">
                        <div class="user-item">
                            <div class="user-heading">
                                <h3>User</h3>
                            </div>

                            <table style="width: 90%;">
                                <tr>
                                    <th>No.</th>
                                    <th>Email</th>
                                    <th>Name</th>
                                    <th>Address</th>
                                    <th>Avatar</th>
                                    <th>Birthday</th>
                                    <th>Phone number</th>
                                    <th>Gender</th>
                                    <th>Active</th>
                                    <th>Block</th>
                                </tr>
                                <% for(var i=0; i<users.length;i++) { %>

                                    <tr>
                                        <td>
                                            <%=i+1 %>
                                        </td>
                                        <td>
                                            <%=users[i].email%>
                                        </td>
                                        <td>
                                            <%=users[i].fullname%>
                                        </td>
                                        <td>
                                            <%=users[i].address%>
                                        </td>
                                        <td><img style="width:130px" src="<%=users[i].avatar%>" alt=""></td>
                                        <td>
                                            <%=users[i].birthday%>
                                        </td>
                                        <td>
                                            <%=users[i].phone%>
                                        </td>
                                        <td>
                                            <%=users[i].gender%>
                                        </td>
                                        <td>
                                            <%=users[i].isActive%>
                                        </td>
                                        <td>
                                            <%=users[i].is_block%>
                                        </td>
                                        <td>
                                            <%- include('../components/modalUser.ejs', {user:users[i]})%>
                                        </td>
                                    </tr>
                                    <% } %>

                            </table>
                        </div>
                    </div>
                </div>
            </div>
    </div>
</body>
<script src="https://code.jquery.com/jquery-3.5.0.js"></script>
<script src="https://cdn.jsdelivr.net/npm/popper.js@1.14.7/dist/umd/popper.min.js"
    integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1"
    crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.3.1/dist/js/bootstrap.min.js"
    integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM"
    crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js "
    integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1 "
    crossorigin="anonymous "></script>
<script src="//cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
    // color status order
    let result = $(".order-item--des").innerText;
    const status = document.getElementsByClassName('order-item--des')
    for (let i = 0; i < status.length; i++) {
        if (document.getElementsByClassName('order-item--des')[i].innerText == 'Completed') {
            document.getElementsByClassName('order-item--des')[i].style.color = 'rgba(0,199,0,1)';
        } else {
            document.getElementsByClassName('order-item--des')[i].style.color = 'red'
        }
    }
    function detailProduct(id) {
        //get Category Product to compare the exist account
        const insertImageProduct = $('.image-product-' + id);
        axios.get('/admin/product/' + id).then(res => {
            var checkCategoryProduct = document.getElementsByClassName(`form-check-input-category` + id);
            console.log('checkExistCategory', res.data.message)
            // console.log('checkCategoryProduct', checkCategoryProduct)
            for (let j = 0; j < checkCategoryProduct.length; j++) {
                for (let i = 0; i < res.data.message.categoryProduct.length; i++) {
                    if (checkCategoryProduct[j].attributes[2].value == res.data.message.categoryProduct[i].categoryId) {
                        checkCategoryProduct[j].checked = true
                    }
                }
            }
            //neu co anh
            for (let i = 0; i < res.data.message.productImage.length; i++) {
                const linkImg = res.data.message.productImage[i].href;
                console.log(linkImg)
                const idImg = res.data.message.productImage[i].id;
                let defaultImg = "";
                if (res.data.message.productImage[i].isDefault == true) {
                    defaultImg = "borderImg";
                }
                insertImageProduct.append(`<img class='${defaultImg}' style="cursor: pointer" onclick="mainImg('mainImg-${idImg}')" id="mainImg-${idImg}" width="120px" src='${linkImg}'/>`) //add images to modal
                const newImgs = document.querySelectorAll('div.list-img-product img')
                newImgs.forEach(el => {
                    const current = document.getElementsByClassName('borderImg');
                    el.addEventListener("click", function (e) {
                        console.log('e.target', e.target.id) //target img
                        if (!current.length) {
                            this.classList.add('borderImg');
                        }
                        else {
                            current[0].classList.remove('borderImg');
                            e.target.classList.add('borderImg');
                        }
                    })
                })
            }
        })

    }

    function updateProduct(id) {
        const name = $(`#product-name-${id}`).val();
        const amount = $(`#amount-${id}`).val();
        const price = $(`#price-${id}`).val();
        const description = $(`#description-${id}`).val();
        const categoryId = $(`input[type=checkbox]:checked`).map(function (_, el) {
            return $(el).val();
        }).get();
        axios.put('/admin/product/' + id, {
            name: name,
            description: description,
            amount: amount,
            price: price,
            categoryId: categoryId,
        })
            .then(function (response) {
                if (response.data.status == 200) {
                    Swal.fire({
                        title: 'Updated!',
                        text: response.data.message,
                        icon: 'success',
                        confirmButtonText: 'Cool'
                    })
                } else {
                    Swal.fire({
                        title: 'Something went wrong',
                        text: response.data.message,
                        icon: 'error',
                        confirmButtonText: 'Login'
                    }).then(() => {
                        window.location.href = '/admin/loginView'
                    })
                }
            })
            .catch(function (error) {
                console.log(error);
                Swal.fire({
                    title: 'Something went wrong',
                    text: error.response.data.message,
                    icon: 'error',
                    confirmButtonText: 'Login '
                }).then(() => {
                    window.location.href = '/admin/loginView'
                })
            });
    }

    function mainImg(id) {
        const defaultImg = id.split('-')[1];
        axios.post('/admin/default_image/' + defaultImg)
            .then(function (response) {
                if (response.status === 200) {
                    Swal.fire({
                        position: 'top-end',
                        icon: 'success',
                        title: 'Success',
                        showConfirmButton: false
                    }).then(function () {
                        location.reload();
                    });
                } else {
                    Swal.fire({
                        title: 'Something went wrong',
                        text: response.data.message,
                        icon: 'error',
                        confirmButtonText: ' Not cool'
                    })
                }
            })
            .catch(function (error) {
                console.log(error);
            });
    }

    function addProduct() {
        const name = $('#name').val();
        const amount = $('#amount').val();
        const price = $('#price').val();
        const description = $('#description').val();
        const categoryId = $('input[type=checkbox]:checked').map(function (_, el) {
            return $(el).val();
        }).get();
        axios.post('/admin/product', {
            name: name,
            amount: amount,
            price: price,
            description: description,
            categoryId: categoryId,
        })
            .then(function (response) {
                console.log(response);
            })

    }

    function deleteProduct(id) {
        axios.delete('/admin/product/' + id)
            .then(function (response) {
                console.log(response);
                if (response.data.status == 200) {
                    Swal.fire({
                        title: 'Deleted!',
                        text: response.data.message,
                        icon: 'success',
                        confirmButtonText: 'Cool'
                    }).then(() => {
                        location.reload();
                    })
                } else {
                    Swal.fire({
                        title: 'Something went wrong',
                        text: response.data.message,
                        icon: 'error',
                        confirmButtonText: ' Not cool'
                    })
                }
            })
            .catch(function (error) {
                console.log(error);
            });
    }

    function changeBlockUserStt(id) {
        axios.post('/admin/changeBlockUserStt/' + id,)
            .then(function (response) {
                if (response.status === 200) {
                    Swal.fire({
                        position: 'top-end',
                        icon: 'success',
                        title: 'Success',
                        showConfirmButton: false
                    }).then(function () {
                        location.reload();
                    });
                } else {
                    Swal.fire({
                        title: 'Something went wrong',
                        text: response.data.message,
                        icon: 'error',
                        confirmButtonText: ' Not cool'
                    })
                }
            })
            .catch(function (error) {
                console.log(error);
            });
    }

    function deleteUser(id) {
        axios.delete('/admin/user/' + id)
            .then(res => {
                Swal.fire({
                    position: 'center',
                    icon: 'success',
                    title: 'Deleted user',
                    showConfirmButton: false
                });
                setTimeout(function () {
                    window.location.reload();
                }, 1500);
            })
            .catch(error => {
                Swal.fire({
                    icon: 'error',
                    title: 'Oops...',
                    text: 'Something went wrong!',
                    footer: '<a href>Why do I have this issue?</a>'
                })
            })
    }

    function updateCategory(id) {
        const categoryName = $('#category-name').val();
        const categoryDescription = $('#category-description').val();
        console.log(categoryName, categoryDescription)
        axios.post('/admin/editCategory/' + id, {
            name: categoryName,
            description: categoryDescription
        })
            .then(function (response) {
                if (response.status == 200) {
                    Swal.fire({
                        title: 'Updated!',
                        text: response.data.message,
                        icon: 'success',
                        confirmButtonText: 'Cool'
                    }).then(() => {
                        location.reload();
                    })
                } else {
                    Swal.fire({
                        title: 'Something went wrong',
                        text: response.data.message,
                        icon: 'error',
                        confirmButtonText: ' Not cool'
                    })
                }
            })
            .catch(function (error) {
                console.log(error);
            });
    }

    function deleteCategory(id) {
        axios.delete('/admin/category/' + id)
            .then(res => {
                Swal.fire({
                    position: 'top-end',
                    icon: 'success',
                    title: 'Deleted!',
                    showConfirmButton: false
                });
                setTimeout(function () {
                    window.location.reload();
                }, 1500);
            })
            .catch(error => {
                Swal.fire({
                    icon: 'error',
                    title: 'Oops...',
                    text: 'Something went wrong!',
                    footer: '<a href>Why do I have this issue?</a>'
                })
            })
    }

    function changeStatus(id) {
        let newStatus;
        const orderStatus = $('.form-check-input-order-status');
        for (let i = 0; i < orderStatus.length; i++) {
            if (orderStatus[i].checked) {
                newStatus = orderStatus[i].value;
            }
        }
        console.log('newStatus', newStatus)
        axios.post('/admin/change_order_status/' + id, {
            newStatus: newStatus
        })
            .then(function (response) {
                if (response.status == 200) {
                    Swal.fire({
                        title: 'Updated!',
                        text: response.data.message,
                        icon: 'success',
                        confirmButtonText: 'Cool'
                    }).then(() => {
                        location.reload();
                    })
                } else {
                    Swal.fire({
                        title: 'Something went wrong',
                        text: response.data.message,
                        icon: 'error',
                        confirmButtonText: ' Not cool'
                    })
                }
            })
            .catch(function (error) {
                console.log(error);
            });
    }
</script>

</html>